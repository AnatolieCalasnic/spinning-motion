stages: 
    - build 
    - test
    - docker
    - sonarqube-check
build: 
    stage: build 
    script: 
        - ./gradlew assemble 
test:
    stage: test
    script:
        - ./gradlew test

docker:
    script:
        # PowerShell-friendly container cleanup
        - docker stop spinning-motion; if ($LASTEXITCODE -eq 1) { exit 0 }
        - docker stop mysql-container; if ($LASTEXITCODE -eq 1) { exit 0 }
        - docker rm spinning-motion; if ($LASTEXITCODE -eq 1) { exit 0 }
        - docker rm mysql-container; if ($LASTEXITCODE -eq 1) { exit 0 }
        
        # Network cleanup with error handling
        - docker network rm ${DOCKER_NETWORK}; if ($LASTEXITCODE -eq 1) { exit 0 }
        - docker network create ${DOCKER_NETWORK}

        # Start MySQL container
        - docker run -d --name mysql-container --net=${DOCKER_NETWORK} -e "MYSQL_DATABASE=${MYSQL_DATABASE}" -e "MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}" mysql:8.0

        # Build and run application
        - docker build -t spinning-motion .
        - docker run -d --name spinning-motion --net=${DOCKER_NETWORK} -p 8093:8080 --env spring_profiles_active=staging spinning-motion
    only:
        - main
    dependencies:
        - build
sonarqube-check:
    stage: sonarqube-check
    script:
        - ./gradlew test jacocoTestReport

